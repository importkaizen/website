<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>apostle</title>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/png" href="pyramid%20.png">
    <link rel="apple-touch-icon" href="pyramid%20.png">
    <style>

#welcome > h2 {
            font-weight: 700;
            text-shadow: 0.4px 0 currentColor, -0.4px 0 currentColor;
            letter-spacing: 0.06em;
            margin: 30px 0 28px 0em;
        }
        body {
            font-family: 'Cormorant Garamond', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, serif;
            line-height: 1.2;
            font-size: 20px;
            background: #4d362b;
            color: #fff;
            padding: 40px 20px 40px 275px;
            max-width: 900px;
        }

        h1 {
            position: fixed;
            top: 12px;
            left: 12px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            margin: 0;
            z-index: 999;
            background: transparent;
            padding: 4px 6px;
        }

        /* general headings alignment */
        h2 {
            font-size: 1.2em;
            font-weight: 600;
            margin: 20px 0 10px 0.5em;
            cursor: pointer;

        }

        h3 {
            font-size: 1em;
            font-weight: 600;
            margin: 20px 0 10px 0.5em;


        }

        p {
            margin-left: 1em;
            text-align: justify;
            text-justify: inter-word;
            -webkit-hyphens: auto;
            -ms-hyphens: auto;
            hyphens: auto;
            text-align-last: left;
        }

        a {
            color: #fff;
            text-decoration: underline;
            cursor: pointer;
        }

        a:hover {
            color: #ddd;
        }

        /* link preview tooltip */
        .link-preview {
            position: absolute;
            background: rgba(77, 54, 43, 0.95);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 12px 16px;
            max-width: 300px;
            font-size: 0.85em;
            line-height: 1.4;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-5px);
            transition: opacity 0.2s ease, transform 0.2s ease;
            margin-top: 8px;
        }

        .link-preview.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .link-preview-title {
            font-weight: 600;
            margin-bottom: 4px;
            color: #fff;
        }

        .link-preview-content {
            color: #ddd;
            font-size: 0.9em;
        }


        .note {
            margin: 30px 0;
            padding: 30px 0;
            border-top: 1px solid #fff;
            max-width: 48ch;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.4s cubic-bezier(.2,.9,.2,1), transform 0.4s cubic-bezier(.2,.9,.2,1);
        }

        .note.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .note.collapsed .note-body {
            display: none;
        }

        /* depth indicator - subtle visual hierarchy */
        .note[data-depth="1"] {
            border-left: 2px solid rgba(255,255,255,0.15);
            padding-left: 20px;
            margin-left: 10px;
        }

        .note[data-depth="2"] {
            border-left: 2px solid rgba(255,255,255,0.1);
            padding-left: 30px;
            margin-left: 20px;
        }

        .note[data-depth="3"] {
            border-left: 2px solid rgba(255,255,255,0.05);
            padding-left: 40px;
            margin-left: 30px;
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .note-title {
            font-size: 1.1em;
            font-weight: 600;
        }

        /* remove underline for the top welcome link specifically */
        #welcome > h2 > a.note-title {
            text-decoration: none;
        }

        .close-link {
            color: #ddd;
            text-decoration: none;
            font-size: 0.9em;
        }

        .close-link:hover {
            color: #fff;
        }

        .backlinks {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #fff;
        }

        .backlinks > .backlinks-title,
        .backlinks > a {
            display: none;
        }

        .backlinks-title {
            font-size: 0.9em;
            color: #ddd;
            margin-bottom: 8px;
        }

        .backlinks a {
            font-size: 0.9em;
            margin-right: 10px;
        }

        ul {
            margin: 15px 0;
            padding-left: 30px;
        }

        li {
            margin: 8px 0;
        }

        p {
            margin: 12px 0;
            text-align: justify;
            text-justify: inter-word;
            -webkit-hyphens: auto;
            -ms-hyphens: auto;
            hyphens: auto;
            text-align-last: left;
        }

        /* ensure dynamic note content is justified */
        .note-content, .note-content p, .note-content li {
            text-align: justify;
            text-justify: inter-word;
            -webkit-hyphens: auto;
            -ms-hyphens: auto;
            hyphens: auto;
            text-align-last: left;
        }

        .icon {
            display: inline-block;
            margin: 10px 0;
        }

        #welcome {
            border-top: none;
        }
        /* right-side decorative image and dynamic roots reveal */
        #leafless-tree-wrap {
            position: fixed;
            right: 275px; /* match the left content padding distance */
            top: 35%;
            transform: translateY(-50%);
            max-width: 480px; /* allow a larger image */
            width: 24vw;
            height: auto; /* show full tree */
            z-index: 900;
            pointer-events: none;
            overflow: visible;
            background: transparent;
            display: flex;
            align-items: flex-end;
        }

        #leafless-tree {
            display: block;
            width: 100%;
            height: auto;
            pointer-events: none;
            user-select: none;
            opacity: 1;
            transition: opacity 0.7s cubic-bezier(.4,0,.2,1);
            mask-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 600"><path id="burnmask" d="M0,0 Q200,40 400,0 V600 H0 Z" fill="white"/></svg>');
            mask-size: cover;
            mask-repeat: no-repeat;
        }

        #leafless-tree.burned {
            opacity: 0;
            transition: opacity 0.7s cubic-bezier(.7,0,.2,1);
        }

        /* a roots layer that scales up from the bottom as notes open */
        #tree-roots {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0; /* align with tree base */
            width: 90%;
            height: 140px; /* match viewBox height */
            pointer-events: none;
            z-index: 899;
            overflow: visible;
        }

        #tree-roots svg {
            width: 100%;
            height: auto;
            display: block;
            overflow: visible;
        }

        /* root fills removed - using thin strokes only */

        /* each branch will scale up from its bottom anchor */
        .root-branch {
            opacity: 0.0;
            stroke-linejoin: round;
            stroke-linecap: round;
            stroke: #1a1a1a;
            stroke-width: 1.8;
            transition: opacity 260ms ease;
        }

        /* when a branch has 'revealed', we'll animate its stroke-dashoffset via JS */
        .root-branch.revealed {
            opacity: 1;
        }

        /* breadcrumb trail */
        #breadcrumb {
            position: fixed;
            top: 12px;
            left: 120px;
            font-size: 0.85em;
            color: #ddd;
            z-index: 998;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #breadcrumb.visible {
            opacity: 1;
        }

        #breadcrumb a {
            color: #ddd;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        #breadcrumb a:hover {
            color: #fff;
        }

        #breadcrumb span {
            margin: 0 6px;
            color: #999;
        }

        /* connection lines between notes */
        .note-connection {
            position: absolute;
            pointer-events: none;
            z-index: 1;
            opacity: 0.08;
            stroke: #fff;
            stroke-width: 1;
            fill: none;
        }

        /* smooth transitions for note closing */
        .note.closing {
            opacity: 0;
            transform: translateY(-10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        @media (max-width: 900px) {
            #leafless-tree-wrap { display: none; }
            #breadcrumb { display: none; }
        }
    </style>
</head>
<body>
    <h1><a href="javascript:void(0)">apostle</a></h1>
    <div id="breadcrumb"></div>
    <div id="leafless-tree-wrap">
        <img id="leafless-tree" src="leaflessTree.jpg" alt="leafless tree" onerror="this.style.display='none'">
        <div id="tree-roots" aria-hidden="true">
            <!-- multiple root branches; they will be revealed progressively -->
            <svg viewBox="0 0 320 140" preserveAspectRatio="xMidYMax meet">
                <g fill="none" stroke-linecap="round" stroke-linejoin="round">
                        <!-- thin black root branches growing from base (flipped: start at Y=140, grow downward) -->
                        <path class="root-branch" d="M8 120 C28 92, 38 70, 48 36" />
                        <path class="root-branch" d="M28 126 C48 96, 60 74, 74 38" />
                        <path class="root-branch" d="M48 122 C68 94, 86 66, 98 30" />
                        <path class="root-branch" d="M68 128 C88 98, 106 68, 120 30" />
                        <path class="root-branch" d="M92 130 C112 102, 134 72, 148 32" />
                        <path class="root-branch" d="M116 126 C136 96, 156 66, 172 28" />
                        <path class="root-branch" d="M140 124 C160 94, 182 64, 198 24" />
                        <path class="root-branch" d="M164 128 C184 96, 204 64, 222 22" />
                        <path class="root-branch" d="M188 122 C208 88, 228 56, 252 16" />
                        <path class="root-branch" d="M212 118 C232 84, 252 54, 276 12" />
                        <path class="root-branch" d="M236 114 C256 80, 276 48, 300 8" />
                        <path class="root-branch" d="M16 134 C36 110, 56 86, 80 46" />
                        <path class="root-branch" d="M40 138 C60 114, 84 86, 110 44" />
                        <path class="root-branch" d="M64 136 C84 110, 108 80, 136 40" />
                        <path class="root-branch" d="M88 140 C108 110, 132 76, 164 36" />
                        <path class="root-branch" d="M112 132 C132 104, 156 68, 192 24" />
                        <path class="root-branch" d="M136 134 C156 104, 182 64, 216 22" />
                        <path class="root-branch" d="M160 136 C180 106, 208 66, 248 20" />
                        <path class="root-branch" d="M184 132 C204 100, 236 60, 284 12" />
                        <path class="root-branch" d="M208 128 C228 96, 260 54, 308 8" />
                    </g>
            </svg>
        </div>
    </div>
    <div id="notes-container">
        <div class="note visible" id="welcome" data-depth="0">
            <h2><a class="note-title" href="?note=welcome">Welcome</a></h2>
            <div class="note-body">
                <p>Welcome to <a href="?note=about-me">my</a> bite-sized <a href="?note=digital-forest">digital forest</a>, here you can learn about me, find my notes, blogposts and ideas</p>

                <p>Internal links go to other forest pages, they will open under the current node, so you can navigate the forest without having to keep different tabs open (you can do that as well if you want by using middle click). If you are seeing this under a browser that doesn't support javascript links will work as normal and you will navigate to each note individually.</p>

                <p>If you wanna remove a note from your view, you can click on [close]. (This Welcome note is the only one you can't close, to make sure you can always navigate somewhere). Notes are collapsible if you click on the titles.</p>

                <p>From here you can start exploring the forest, the forest has no search and no direct access to pages. This is a bit of an experiment to encourage exploring around. Everything has to be accessible through other pages.</p>

                <p>Currently (2025/12/25) doing <a href="?note=december-adventure">december adventure</a>.</p>

                <p>Here are some starting points to get you into the forest:</p>

                <ul>
                    <li><a href="?note=programming">programming</a></li>
                    <li><a href="?note=blog-posts">blog posts</a></li>
                    <li><a href="?note=projects">projects</a></li>
                    <li><a href="?note=interests">interests</a></li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const notes = {
            'about-me': {
                title: 'about me',
                content: `
                    <p>My name is [Your Name], I'm a [your role] from [Your Location].</p>
                    
                    <p>Currently working at [Company/Project].</p>
                    
                    <p>You can read a bit about my <a href="?note=programming">programming</a> background.</p>
                    
                    <p>You can reach me at [your email] if you want me to expand on a topic.</p>
                `,
                backlinks: ['welcome', 'programming', 'projects']
            },
            'digital-forest': {
                title: 'digital forest',
                content: `
                    <p>A digital forest is a metaphor for a personal knowledge space - an interconnected collection of notes, thoughts, and ideas that grow organically over time.</p>
                    
                    <p>Unlike a traditional blog or portfolio, a digital forest encourages exploration and discovery. There's no chronological order or rigid structure, just paths between related concepts.</p>
                    
                    <p>The idea is inspired by the concept of a <a href="?note=digital-garden">digital garden</a> - a space where ideas are cultivated rather than published.</p>
                `,
                backlinks: ['welcome']
            },
            'digital-garden': {
                title: 'digital garden',
                content: `
                    <p>Digital gardens are a different way of thinking about online content. Rather than a stream of posts in reverse chronological order, it's a network of interconnected notes that evolve over time.</p>
                    
                    <p>Key principles:</p>
                    <ul>
                        <li>Work with the garage door up - share imperfect, evolving thoughts</li>
                        <li>Connect ideas through links rather than categories</li>
                        <li>Tend and revise notes over time</li>
                        <li>Encourage exploration over consumption</li>
                    </ul>
                `,
                backlinks: ['digital-forest']
            },
            'programming': {
                title: 'programming',
                content: `
                    <p>I work primarily with [your main languages/technologies].</p>
                    
                    <h3>Current interests</h3>
                    <ul>
                        <li>[Technology/concept 1]</li>
                        <li>[Technology/concept 2]</li>
                        <li>[Technology/concept 3]</li>
                    </ul>
                    
                    <p>You can see some of my work in <a href="?note=projects">projects</a>.</p>
                `,
                backlinks: ['welcome', 'about-me', 'projects']
            },
            'projects': {
                title: 'projects',
                content: `
                    <h3>Active Projects</h3>
                    
                    <p><strong>Project Name 1</strong> - Brief description of what this project does and why it's interesting.</p>
                    
                    <p><strong>Project Name 2</strong> - Another project with its purpose and current status.</p>
                    
                    <h3>Past Work</h3>
                    
                    <p><strong>Completed Project</strong> - What you learned and accomplished.</p>
                `,
                backlinks: ['welcome', 'programming']
            },
            'blog-posts': {
                title: 'blog posts',
                content: `
                    <p>Thoughts and explorations, in roughly reverse chronological order:</p>
                    
                    <ul>
                        <li><a href="?note=post-1">Post Title 1</a> - Brief description</li>
                        <li><a href="?note=post-2">Post Title 2</a> - Brief description</li>
                        <li><a href="?note=post-3">Post Title 3</a> - Brief description</li>
                    </ul>
                `,
                backlinks: ['welcome']
            },
            'interests': {
                title: 'interests',
                content: `
                    <p>Beyond <a href="?note=programming">programming</a>, I'm interested in:</p>
                    
                    <ul>
                        <li>[Interest 1]</li>
                        <li>[Interest 2]</li>
                        <li>[Interest 3]</li>
                    </ul>
                    
                    <p>These often influence my approach to <a href="?note=projects">projects</a>.</p>
                `,
                backlinks: ['welcome']
            },
            'december-adventure': {
                title: 'december adventure',
                content: `
                    <p>December Adventure is a casual, low-pressure alternative to Advent of Code. Instead of daily coding challenges, you spend December working on whatever you want - learning something new, building a project, or just experimenting.</p>
                    
                    <p>The only rule: share something about what you did each day.</p>
                    
                    <p>My December Adventure progress:</p>
                    <ul>
                        <li>Day 1-22: Haven't heard of it</li>
                        <li>Day 23: Started this website</li>
                        <li>Day 24: Worked more on this website</li>
                        <li>Day 25: Worked more on this website</li>
                        
                    </ul>
                `,
                backlinks: ['welcome']
            },
            'post-1': {
                title: 'Example Post Title',
                content: `
                    <p><em>2024-12-15</em></p>
                    
                    <p>This is where your blog post content would go. Write about what you're learning, building, or thinking about.</p>
                    
                    <h3>Main Point</h3>
                    <p>Develop your thoughts with examples and explanations.</p>
                `,
                backlinks: ['blog-posts']
            },
            'post-2': {
                title: 'Another Post',
                content: `
                    <p><em>2024-11-20</em></p>
                    
                    <p>More thoughts and ideas here.</p>
                `,
                backlinks: ['blog-posts']
            },
            'post-3': {
                title: 'Third Post',
                content: `
                    <p><em>2024-10-10</em></p>
                    
                    <p>Share your process and discoveries.</p>
                `,
                backlinks: ['blog-posts']
            }
        };

        const openNotes = new Set(['welcome']);
        const navigationPath = ['welcome'];
        const noteDepth = new Map([['welcome', 0]]);
        let linkPreviewTimeout = null;
        let currentLinkPreview = null;

        function openNote(noteId, fromNoteId = null) {
            if (openNotes.has(noteId)) {
                const el = document.getElementById(noteId === 'welcome' ? 'welcome' : `note-${noteId}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                updateBreadcrumb();
                return;
            }

            const note = notes[noteId];
            if (!note) return;

            // calculate depth
            const depth = fromNoteId ? (noteDepth.get(fromNoteId) || 0) + 1 : 0;
            noteDepth.set(noteId, depth);

            // update navigation path - only add if not already there
            if (fromNoteId && navigationPath[navigationPath.length - 1] !== fromNoteId) {
                // Remove any existing instances of fromNoteId to avoid duplicates
                const fromIndex = navigationPath.lastIndexOf(fromNoteId);
                if (fromIndex > -1) {
                    navigationPath.splice(fromIndex + 1);
                } else {
                    navigationPath.push(fromNoteId);
                }
            }
            // Remove noteId if it's already in the path (to avoid duplicates)
            const existingIndex = navigationPath.indexOf(noteId);
            if (existingIndex > -1) {
                navigationPath.splice(existingIndex);
            }
            navigationPath.push(noteId);

            openNotes.add(noteId);
            // update roots length when a new note is opened
            requestAnimationFrame(() => {
                updateRoots();
            });

            const noteHTML = `
                <div class="note" id="note-${noteId}" data-depth="${depth}">
                            <div class="note-header">
                                <a class="note-title" href="?note=${noteId}">${note.title}</a>
                                <a href="javascript:void(0)" class="close-link" onclick="closeNote('${noteId}')">[close]</a>
                            </div>
                            <div class="note-body">
                                <div class="note-content">
                                    ${note.content}
                                </div>
                                ${note.backlinks ? `
                                    <div class="backlinks">
                                        <div class="backlinks-title">backlinks</div>
                                        ${note.backlinks.map(link => `<a href="?note=${link}">${link.replace(/-/g, ' ')}</a>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                </div>
            `;

            document.getElementById('notes-container').insertAdjacentHTML('beforeend', noteHTML);

            // animate in
            requestAnimationFrame(() => {
                const el = document.getElementById(`note-${noteId}`);
                if (el) {
                    el.classList.add('visible');
                    setTimeout(() => {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 50);
                }
            });

            // ensure any notes tracked in `openNotes` remain visible (not collapsed)
            setTimeout(() => {
                openNotes.forEach(id => {
                    const el = (id === 'welcome') ? document.getElementById('welcome') : document.getElementById(`note-${id}`);
                    if (el) el.classList.remove('collapsed');
                });
            }, 10);

            updateBreadcrumb();
            setupLinkPreviews();
            // Delay connection drawing to avoid layout issues
            setTimeout(drawConnections, 100);
        }

        function closeNote(noteId) {
            const noteElement = document.getElementById(`note-${noteId}`);
            if (noteElement) {
                noteElement.classList.add('closing');
                setTimeout(() => {
                    noteElement.remove();
                    openNotes.delete(noteId);
                    noteDepth.delete(noteId);
                    // remove from navigation path (but keep welcome)
                    const index = navigationPath.indexOf(noteId);
                    if (index > -1 && index > 0) {
                        navigationPath.splice(index, 1);
                        // Ensure we don't have duplicates
                        const lastIndex = navigationPath.lastIndexOf(noteId);
                        if (lastIndex > -1) {
                            navigationPath.splice(lastIndex, 1);
                        }
                    }
                    // Ensure welcome is always first
                    if (navigationPath[0] !== 'welcome') {
                        navigationPath.unshift('welcome');
                    }
                    // update roots when a note is closed
                    requestAnimationFrame(() => {
                        updateRoots();
                    });
                    updateBreadcrumb();
                    drawConnections();
                }, 300);
            }
        }

        // Global click handler (capture): intercept clicks on links with ?note=
        // to open notes via JS and prevent full-page navigation on left-click.
        document.addEventListener('click', function(e) {
            const a = e.target && e.target.closest && e.target.closest('a');
            if (a) {
                try {
                    const u = new URL(a.href, window.location.href);
                    const nid = u.searchParams.get('note');
                    if (nid && nid !== 'welcome' && e.button === 0 && !e.metaKey && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                        e.preventDefault();
                        const currentNote = a.closest('.note');
                        const currentNoteId = currentNote ? (currentNote.id === 'welcome' ? 'welcome' : currentNote.id.replace('note-', '')) : null;
                        if (!openNotes.has(nid)) openNote(nid, currentNoteId);
                        else {
                            const el = (nid === 'welcome') ? document.getElementById('welcome') : document.getElementById(`note-${nid}`);
                            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return;
                    }
                } catch (err) {
                    // ignore
                }
            }
        }, true);

        // Delegated handler: handle clicks for anchors (allow middle-click/new-tab),
        // and left-click/keyboard for toggling collapse.
        document.getElementById('notes-container').addEventListener('click', function(e) {
            const t = e.target;

            // If clicking a title link (anchor), allow middle-click / modifier-click to open in new tab.
            const titleLink = t.closest && t.closest('a.note-title, h2 a');
            if (titleLink) {
                const noteEl = titleLink.closest('.note');
                // extract note id from href param if present
                let noteId = null;
                try {
                    const url = new URL(titleLink.href);
                    noteId = url.searchParams.get('note');
                } catch (err) {
                    // ignore
                }

                    // Left click without modifiers: prevent navigation.
                    // If the link points to a note (has a ?note= param) open that note
                    // but do NOT collapse the source note. Only toggle collapse for
                    // non-link headings handled elsewhere.
                    if (e.button === 0 && !e.metaKey && !e.ctrlKey && !e.shiftKey && !e.altKey) {
                        e.preventDefault();
                        if (noteId) {
                            if (noteId === 'welcome') {
                                if (noteEl) {
                                    noteEl.classList.toggle('collapsed');
                                    // Animate tree burn/regrow
                                    const tree = document.getElementById('leafless-tree');
                                    if (tree) {
                                        if (noteEl.classList.contains('collapsed')) {
                                            tree.classList.add('burned');
                                        } else {
                                            tree.classList.remove('burned');
                                        }
                                    }
                                }
                            } else {
                                const currentNote = noteEl;
                                const currentNoteId = currentNote ? (currentNote.id === 'welcome' ? 'welcome' : currentNote.id.replace('note-', '')) : null;
                                if (!openNotes.has(noteId)) openNote(noteId, currentNoteId);
                            }
                        } else {
                            if (noteEl) noteEl.classList.toggle('collapsed');
                        }
                    }
                // otherwise let the browser handle middle-click / open-in-new-tab
                return;
            }

            // legacy: clicking on h2 (non-anchor) or other .note-title elements toggles collapse
            if (t.matches && (t.matches('h2') || t.matches('.note-title'))) {
                // If the clicked element (or its closest anchor) points to a ?note= param,
                // we should not toggle collapse here (that click is handled above).
                const possibleLink = t.closest && t.closest('a');
                let linkTargetsNote = false;
                if (possibleLink) {
                    try {
                        const u = new URL(possibleLink.href);
                        linkTargetsNote = !!u.searchParams.get('note');
                    } catch (err) {
                        linkTargetsNote = false;
                    }
                }
                if (!linkTargetsNote) {
                    const noteEl = t.closest('.note');
                    if (noteEl) noteEl.classList.toggle('collapsed');
                }
            }
        });

        document.getElementById('notes-container').addEventListener('keydown', function(e) {
            const t = e.target;
            if ((t.matches && (t.matches('h2') || t.matches('.note-title') || t.matches('a.note-title'))) && (e.key === 'Enter' || e.key === ' ')) {
                e.preventDefault();
                // For keyboard activation, if this element is an anchor with a ?note parameter,
                // open the referenced note instead of toggling collapse.
                const anchor = t.closest && t.closest('a');
                let noteId = null;
                if (anchor) {
                    try { noteId = (new URL(anchor.href)).searchParams.get('note'); } catch (err) { noteId = null; }
                }
                if (noteId) {
                    const currentNote = t.closest('.note');
                    const currentNoteId = currentNote ? (currentNote.id === 'welcome' ? 'welcome' : currentNote.id.replace('note-', '')) : null;
                    if (!openNotes.has(noteId)) openNote(noteId, currentNoteId);
                } else {
                    const noteEl = t.closest('.note');
                    if (noteEl) noteEl.classList.toggle('collapsed');
                }
            }
        });

        // Breadcrumb update
        function updateBreadcrumb() {
            const breadcrumbEl = document.getElementById('breadcrumb');
            if (!breadcrumbEl) return;
            
            // Filter out invalid note IDs
            const validPath = navigationPath.filter(id => id === 'welcome' || notes[id]);
            
            if (validPath.length <= 1) {
                breadcrumbEl.classList.remove('visible');
                return;
            }
            
            breadcrumbEl.classList.add('visible');
            breadcrumbEl.innerHTML = validPath.map((id, index) => {
                const title = id === 'welcome' ? 'welcome' : (notes[id] ? notes[id].title : id.replace(/-/g, ' '));
                if (index === validPath.length - 1) {
                    return `<span>${title}</span>`;
                }
                return `<a href="?note=${id}">${title}</a><span>â€º</span>`;
            }).join('');
        }

        // Link preview on hover
        const linkPreviewHandlers = new WeakSet();
        function setupLinkPreviews() {
            document.querySelectorAll('a[href*="?note="]').forEach(link => {
                if (linkPreviewHandlers.has(link)) return;
                linkPreviewHandlers.add(link);
                
                link.addEventListener('mouseenter', function(e) {
                    clearTimeout(linkPreviewTimeout);
                    const url = new URL(this.href, window.location.href);
                    const noteId = url.searchParams.get('note');
                    if (!noteId || !notes[noteId]) return;

                    const note = notes[noteId];
                    const preview = document.createElement('div');
                    preview.className = 'link-preview';
                    preview.innerHTML = `
                        <div class="link-preview-title">${note.title}</div>
                        <div class="link-preview-content">${note.content.substring(0, 120).replace(/<[^>]*>/g, '')}...</div>
                    `;
                    document.body.appendChild(preview);
                    currentLinkPreview = preview;

                    const rect = this.getBoundingClientRect();
                    preview.style.left = Math.min(rect.left, window.innerWidth - 320) + 'px';
                    preview.style.top = (rect.bottom + window.scrollY) + 'px';

                    requestAnimationFrame(() => {
                        preview.classList.add('visible');
                    });
                });

                link.addEventListener('mouseleave', function() {
                    if (currentLinkPreview) {
                        currentLinkPreview.classList.remove('visible');
                        linkPreviewTimeout = setTimeout(() => {
                            if (currentLinkPreview && currentLinkPreview.parentNode) {
                                currentLinkPreview.parentNode.removeChild(currentLinkPreview);
                            }
                            currentLinkPreview = null;
                        }, 200);
                    }
                });
            });
        }

        // Draw connection lines between related notes
        function drawConnections() {
            // Remove existing connections
            document.querySelectorAll('.note-connection').forEach(el => el.remove());

            if (openNotes.size < 2) return;

            const noteElements = Array.from(document.querySelectorAll('.note.visible'));
            if (noteElements.length < 2) return;
            
            const connections = [];

            noteElements.forEach(noteEl => {
                const noteId = noteEl.id === 'welcome' ? 'welcome' : noteEl.id.replace('note-', '');
                const note = notes[noteId];
                if (!note || !note.backlinks) return;

                note.backlinks.forEach(backlinkId => {
                    if (openNotes.has(backlinkId)) {
                        const targetEl = backlinkId === 'welcome' 
                            ? document.getElementById('welcome')
                            : document.getElementById(`note-${backlinkId}`);
                        if (targetEl && noteEl !== targetEl && targetEl.classList.contains('visible')) {
                            // Only connect if both are visible and different
                            const existing = connections.find(c => 
                                (c.from === noteEl && c.to === targetEl) || 
                                (c.from === targetEl && c.to === noteEl)
                            );
                            if (!existing) {
                                connections.push({ from: noteEl, to: targetEl });
                            }
                        }
                    }
                });
            });

            if (connections.length === 0) return;

            // Create SVG overlay for connections
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.className = 'note-connection';
            svg.style.position = 'fixed';
            svg.style.top = '0';
            svg.style.left = '0';
            svg.style.width = '100%';
            svg.style.height = '100%';
            svg.style.pointerEvents = 'none';
            svg.style.zIndex = '1';
            document.body.appendChild(svg);

            connections.forEach(({ from, to }) => {
                try {
                    const fromRect = from.getBoundingClientRect();
                    const toRect = to.getBoundingClientRect();
                    
                    // Only draw if both elements are in viewport
                    if (fromRect.height === 0 || toRect.height === 0) return;
                    
                    const fromX = fromRect.left + fromRect.width / 2;
                    const fromY = fromRect.top + fromRect.height;
                    const toX = toRect.left + toRect.width / 2;
                    const toY = toRect.top;

                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const midY = (fromY + toY) / 2;
                    path.setAttribute('d', `M ${fromX} ${fromY} Q ${fromX} ${midY}, ${toX} ${midY} T ${toX} ${toY}`);
                    svg.appendChild(path);
                } catch (err) {
                    // Skip if there's an error
                }
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Escape to close last opened note
            if (e.key === 'Escape' && !e.target.matches('input, textarea')) {
                if (navigationPath.length > 1) {
                    const lastNote = navigationPath[navigationPath.length - 1];
                    if (lastNote !== 'welcome') {
                        closeNote(lastNote);
                    }
                }
            }

            // Arrow keys for navigation (when not in input)
            if (!e.target.matches('input, textarea, a')) {
                if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    const noteElements = Array.from(document.querySelectorAll('.note.visible'));
                    if (noteElements.length === 0) return;

                    const currentScroll = window.scrollY + window.innerHeight / 2;
                    let targetIndex = -1;

                    for (let i = 0; i < noteElements.length; i++) {
                        const rect = noteElements[i].getBoundingClientRect();
                        const noteTop = rect.top + window.scrollY;
                        if (e.key === 'ArrowDown' && noteTop > currentScroll) {
                            targetIndex = i;
                            break;
                        } else if (e.key === 'ArrowUp' && noteTop < currentScroll) {
                            targetIndex = i;
                        }
                    }

                    if (targetIndex === -1) {
                        targetIndex = e.key === 'ArrowDown' ? 0 : noteElements.length - 1;
                    }

                    noteElements[targetIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });

        // On page load, open note from URL param (so opening ?note=id in a new tab shows it)
        function openNoteFromURL() {
            const params = new URLSearchParams(window.location.search);
            const note = params.get('note');
            if (!note) {
                // Make welcome note visible
                const welcomeEl = document.getElementById('welcome');
                if (welcomeEl) {
                    welcomeEl.classList.add('visible');
                }
                updateBreadcrumb();
                setupLinkPreviews();
                return;
            }
            if (!openNotes.has(note)) {
                openNote(note);
            } else {
                const el = document.getElementById(note === 'welcome' ? 'welcome' : `note-${note}`);
                if (el) el.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // reveal roots by progressively drawing individual branches (stroke animation)
        function updateRoots() {
            const branches = Array.from(document.querySelectorAll('#tree-roots .root-branch'));
            if (!branches.length) return;

            // configurable parameters for growth
            const opened = Math.max(0, openNotes.size - 1); // exclude welcome
            const branchesPerNode = 3; // more branches per opened note for fuller growth
            const totalToReveal = Math.min(branches.length, opened * branchesPerNode);
            const baseDuration = 850; // ms per branch draw
            const stagger = 60; // ms between branch reveals

            // Find the first branch that hasn't been revealed yet
            let firstUnrevealedIndex = branches.findIndex(b => !b.classList.contains('revealed'));
            if (firstUnrevealedIndex < 0) firstUnrevealedIndex = totalToReveal;

            branches.forEach((b, i) => {
                // initialize stroke-dash values once
                if (!b.dataset.inited) {
                    try {
                        const len = Math.ceil(b.getTotalLength());
                        b.style.strokeDasharray = len + ' ' + len;
                        b.style.strokeDashoffset = len;
                        b.style.transition = `stroke-dashoffset ${baseDuration}ms cubic-bezier(.2,.9,.2,1), opacity 260ms ease`;
                        b.dataset.len = len;
                        b.dataset.inited = '1';
                    } catch (err) {
                        b.dataset.inited = '1';
                    }
                }

                const shouldReveal = i < totalToReveal;
                const isRevealed = b.classList.contains('revealed');
                
                if (shouldReveal && !isRevealed) {
                    // Calculate stagger delay relative to the first unrevealed branch
                    const delayIndex = i - firstUnrevealedIndex;
                    // stagger reveals for nicer effect
                    setTimeout(() => {
                        // Double-check the branch still needs to be revealed
                        if (i < Math.min(branches.length, Math.max(0, openNotes.size - 1) * branchesPerNode)) {
                            b.classList.add('revealed');
                            // animate stroke drawing
                            requestAnimationFrame(() => {
                                b.style.strokeDashoffset = '0';
                            });
                        }
                    }, Math.max(0, delayIndex) * stagger);
                } else if (!shouldReveal && isRevealed) {
                    // hide it again (reverse the animation)
                    const len = b.dataset.len || 0;
                    b.classList.remove('revealed');
                    // animate dashoffset back to full length
                    requestAnimationFrame(() => {
                        b.style.strokeDashoffset = len;
                    });
                }
            });
        }

        // ensure update after image loads (in case it's slow)
        const treeImg = document.getElementById('leafless-tree');
        if (treeImg) treeImg.addEventListener('load', updateRoots);

        window.addEventListener('load', function() { 
            openNoteFromURL(); 
            updateRoots();
            setupLinkPreviews();
        });

        // Update connections on scroll/resize (throttled)
        let connectionUpdateTimeout;
        function scheduleConnectionUpdate() {
            clearTimeout(connectionUpdateTimeout);
            connectionUpdateTimeout = setTimeout(drawConnections, 200);
        }
        window.addEventListener('scroll', scheduleConnectionUpdate, { passive: true });
        window.addEventListener('resize', scheduleConnectionUpdate);
    </script>
</body>
</html>